<?xml version="1.0" encoding="UTF-8"?>
<ValidationRule xmlns="http://soap.sforce.com/2006/04/metadata">
    <fullName>Approved_Quote_Required</fullName>
    <active>true</active>
    <description>Case 33073073 - Primary quote status needs to be ‘Approved’ before Opportunity can be moved to ‘Sold’</description>
    <errorConditionFormula>AND(
OR(
IF(
AND(
AND(
NOT(OR(Primary_Oracle_Quote_Status__c=&apos;approved&apos;,Primary_Oracle_Quote_Status__c=&apos;readyForAcceptance&apos;, Primary_Oracle_Quote_Status__c=&apos;SUBSCRIPTION_CREATED&apos;))
),
ISCHANGED(StageName),
BEGINS(TEXT(StageName), &apos;Sold&apos;),
Approved_Quotes_Exception__c = false,
BEGINS($RecordType.Name, &apos;MMS Opportunity&apos;),
ISPICKVAL(Payroll_Platform__c,&apos;PAY&apos;),
JointAppointment__c = false
),

IF(NOT(ISBLANK(Primary_Opportunity__c)),
IF(
AND(
AND(
NOT(OR(Primary_Opportunity__r.Primary_Oracle_Quote_Status__c=&apos;approved&apos;,Primary_Opportunity__r.Primary_Oracle_Quote_Status__c=&apos;readyForAcceptance&apos;,Primary_Oracle_Quote_Status__c=&apos;SUBSCRIPTION_CREATED&apos;))
),
ISCHANGED(StageName),
BEGINS(TEXT(StageName), &apos;Sold&apos;),
Primary_Opportunity__r.Approved_Quotes_Exception__c = false,
BEGINS(Primary_Opportunity__r.RecordType.Name, &apos;MMS Opportunity&apos;),
ISPICKVAL(Primary_Opportunity__r.Payroll_Platform__c,&apos;PAY&apos;),
Primary_Opportunity__r.JointAppointment__c = false
),
TRUE,
FALSE
),

TRUE
),
FALSE
),


IF(

AND(
AND(
NOT(OR(Primary_Oracle_Quote_Status__c=&apos;approved&apos;,Primary_Oracle_Quote_Status__c=&apos;readyForAcceptance&apos;,Primary_Oracle_Quote_Status__c=&apos;SUBSCRIPTION_CREATED&apos;))
),
ISCHANGED(StageName),
BEGINS(TEXT(StageName), &apos;Sold&apos;),
Approved_Quotes_Exception__c = false,
OR(BEGINS($RecordType.Name, &apos;TAA Opportunity&apos;), BEGINS($RecordType.Name, &apos;ASO Opportunity&apos;),BEGINS($RecordType.Name, &apos;PEO Opportunity&apos;),BEGINS($RecordType.Name, &apos;Core Opportunity Record Type&apos;),BEGINS($RecordType.Name, &apos;Core Virtual Sales&apos;),AND(BEGINS($RecordType.Name, &apos;HNBF Opportunity&apos;),ISPICKVAL(OpportunityType__c,&apos;Flock&apos;),Payroll_Units__c=0))
),


IF(NOT(ISBLANK(Primary_Opportunity__c)),
IF(
AND(
AND(
NOT(OR(Primary_Opportunity__r.Primary_Oracle_Quote_Status__c=&apos;approved&apos;,Primary_Opportunity__r.Primary_Oracle_Quote_Status__c=&apos;readyForAcceptance&apos;,Primary_Oracle_Quote_Status__c=&apos;SUBSCRIPTION_CREATED&apos;))
),
ISCHANGED(StageName),
BEGINS(TEXT(StageName), &apos;Sold&apos;),
Primary_Opportunity__r.Approved_Quotes_Exception__c = false,
OR(BEGINS($RecordType.Name, &apos;TAA Opportunity&apos;), BEGINS($RecordType.Name, &apos;ASO Opportunity&apos;),BEGINS($RecordType.Name, &apos;PEO Opportunity&apos;),BEGINS($RecordType.Name, &apos;Core Opportunity Record Type&apos;),BEGINS($RecordType.Name, &apos;Core Virtual Sales&apos;),AND(BEGINS($RecordType.Name, &apos;HNBF Opportunity&apos;),ISPICKVAL(OpportunityType__c,&apos;Flock&apos;),Payroll_Units__c=0))
),
TRUE,
FALSE
),
TRUE
),
FALSE

)
),

OR ($User.Job_Name__c = &apos;Sales Representative&apos;
,$User.Job_Name__c = &apos;District Sales Manager&apos;
,$User.Job_Name__c = &apos;District Sales Assistant&apos;
,$User.Job_Name__c = &apos;Area Manager&apos;
,$User.Job_Name__c = &apos;Area Assistant&apos;
,$User.Job_Name__c = &apos;Zone Manager&apos;
,$User.Job_Name__c = &apos;Zone Assistant&apos;
,$Profile.Name = &apos;MMS SDR&apos;
),$User.CPQ_Mandate_Eligibility__c = true,
NOT(OR(ISPICKVAL(OpportunityType__c,&apos;Adjustment&apos;),ISPICKVAL(OpportunityType__c,&apos;Chargeback&apos;),ISPICKVAL(OpportunityType__c,&apos;True-Up&apos;),ISPICKVAL(OpportunityType__c,&apos;Balance&apos;),ISPICKVAL(OpportunityType__c,&apos;Save&apos;),ISPICKVAL(OpportunityType__c,&apos;Split&apos;),ISPICKVAL(OpportunityType__c,&apos;ERTC&apos;),ISPICKVAL(OpportunityType__c,&apos;SurePayroll&apos;),ISPICKVAL(OpportunityType__c,&apos;Surepayroll HRE&apos;),ISPICKVAL(OpportunityType__c,&apos;SurePayroll 401k&apos;),ISPICKVAL(OpportunityType__c,&apos;Surepayroll ASO&apos;))),

NOT(AND($User.Sales_Division__c = &apos;Strategic Accounts&apos;, $Profile.Name = &apos;Core Sales - SB&apos;)),

NOT($User.Sales_Division__c = &apos;PEO&apos;),

NOT(ISPICKVAL(LeadSource, &apos;Acquisition&apos;)),

NOT(BEGINS($Profile.Name, &apos;System Administrator&apos;)),

NOT(AND(BEGINS(TEXT(LeadSource),&apos;Referral-CPA&apos;), Referral_Contact__r.Referral_Account__r.Hosted_Client__c)),


DATEVALUE(CreatedDate) &gt;= DATE(2020,11,01)

)</errorConditionFormula>
    <errorMessage>Approved Quote Required - Primary quote status needs to be Approved before Opportunity can be moved to Sold</errorMessage>
</ValidationRule>
